name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ['CI - Build and Test', 'CodeQL Security Analysis']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  check-workflows:
    name: Check if all required workflows completed
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check both CI and CodeQL workflows status
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            // Handle both workflow_run and workflow_dispatch triggers
            const sha = context.eventName === 'workflow_run'
              ? (context.payload.workflow_run?.head_commit?.id || context.payload.workflow_run?.head_sha)
              : context.sha

            if (!sha) {
              throw new Error('Unable to determine commit SHA')
            }

            const workflowsToCheck = [
              'CI - Build and Test',
              'CodeQL Security Analysis'
            ]

            console.log(`Checking workflows for commit ${sha}...`)

            let allCompleted = true
            let allSucceeded = true

            // Get all workflows once to avoid multiple API calls
            const workflows = await github.rest.actions.listRepoWorkflows({ owner, repo })

            for (const workflowName of workflowsToCheck) {
              // Find workflow by name
              const workflow = workflows.data.workflows.find(w => w.name === workflowName)
              if (!workflow) {
                throw new Error(`Workflow '${workflowName}' not found`)
              }
              
              // Get latest run for this workflow on this commit
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                branch: 'main'
              })
              const run = runs.data.workflow_runs.find(r => r.head_sha === sha)
              
              if (!run) {
                throw new Error(`❌ Required workflow '${workflowName}' has no run for commit ${sha}. This may indicate a misconfiguration or a CI failure. Deployment aborted.`)
              }
              
              console.log(`Workflow '${workflowName}': status=${run.status}, conclusion=${run.conclusion}`)
              
              // Check if workflow has completed
              if (run.status !== 'completed') {
                console.log(`⏳ Workflow '${workflowName}' has not completed yet (status: ${run.status})`)
                allCompleted = false
                continue
              }
              
              // Check if workflow succeeded
              if (run.conclusion !== 'success') {
                console.log(`❌ Workflow '${workflowName}' did not succeed (conclusion: ${run.conclusion})`)
                allSucceeded = false
                continue
              }
              
              console.log(`✓ Workflow '${workflowName}' completed successfully`)
            }

            if (!allSucceeded) {
              console.log('❌ Some workflows failed. Aborting deployment.')
              core.setFailed('One or more required workflows failed')
              return
            }

            if (!allCompleted) {
              console.log('⏸ Not all workflows have completed. Skipping deployment for now.')
              core.setOutput('should_deploy', 'false')
              return
            }

            console.log('✓ All required workflows completed successfully. Proceeding with deployment.')
            core.setOutput('should_deploy', 'true')

  build:
    name: Build site for deployment
    runs-on: ubuntu-latest
    needs: check-workflows
    if: needs.check-workflows.outputs.should_deploy == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js site
        run: pnpm run build

      - name: Run tests
        run: pnpm test

      - name: Upload build artifact for Lighthouse
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: ./out
          retention-days: 1

      - name: Verify .nojekyll file exists
        run: |
          if [ ! -f ./out/.nojekyll ]; then
            echo "Error: .nojekyll file not found in ./out directory"
            exit 1
          fi
          echo "✓ .nojekyll file found in ./out directory"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
