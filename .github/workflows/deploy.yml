name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ['CI - Build and Test', 'CodeQL Security Analysis']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    # Removed 'if' condition; status check is now handled in the first step
    steps:
      - name: Ensure both CI and CodeQL workflows succeeded
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            // Handle both workflow_run and workflow_dispatch triggers
            const sha = context.eventName === 'workflow_run'
              ? (context.payload.workflow_run?.head_commit?.id || context.payload.workflow_run?.head_sha)
              : context.sha

            if (!sha) {
              throw new Error('Unable to determine commit SHA')
            }

            const workflowsToCheck = [
              'CI - Build and Test',
              'CodeQL Security Analysis'
            ]
            for (const workflowName of workflowsToCheck) {
              // Get workflow id by name
              const workflows = await github.rest.actions.listRepoWorkflows({ owner, repo })
              const workflow = workflows.data.workflows.find(w => w.name === workflowName)
              if (!workflow) {
                throw new Error(`Workflow '${workflowName}' not found`)
              }
              // Get latest run for this workflow on this commit
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                branch: 'main',
                event: 'push'
              })
              const run = runs.data.workflow_runs.find(r => r.head_sha === sha)
              if (!run) {
                throw new Error(`No run found for workflow '${workflowName}' on commit ${sha}`)
              }
              if (run.conclusion !== 'success') {
                throw new Error(`Workflow '${workflowName}' did not succeed (status: ${run.conclusion})`)
              }
            }
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.0.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js site
        run: pnpm run build

      - name: Run tests
        run: pnpm test

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
