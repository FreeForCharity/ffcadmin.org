name: Auto-Sign Commits

# This workflow automatically signs commits from GitHub Actions/bots
# It triggers on pushes to any branch except main

on:
  push:
    branches:
      - '**'
      - '!main'

permissions:
  contents: write

jobs:
  check-and-sign:
    runs-on: ubuntu-latest
    # Only run for bot commits
    if: |
      github.actor == 'copilot-swe-agent[bot]' ||
      github.actor == 'github-actions[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if GPG key is configured
        id: gpg_check
        run: |
          if [ -n "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Import GPG key
        if: steps.gpg_check.outputs.configured == 'true'
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Check last commit signature
        id: check_signature
        run: |
          # Check if the last commit is signed
          if git verify-commit HEAD 2>/dev/null; then
            echo "signed=true" >> $GITHUB_OUTPUT
            echo "✅ Last commit is already signed"
          else
            echo "signed=false" >> $GITHUB_OUTPUT
            echo "⚠️ Last commit is not signed"
          fi

      - name: Sign last commit
        if: |
          steps.gpg_check.outputs.configured == 'true' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          # Amend the last commit with a signature
          git commit --amend --no-edit -S

          echo "✅ Signed commit: $(git log -1 --pretty=format:'%h - %s')"

      - name: Push signed commit
        if: |
          steps.gpg_check.outputs.configured == 'true' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          git push --force-with-lease
          echo "✅ Pushed signed commit to ${{ github.ref }}"

      - name: Warning if no GPG key
        if: |
          steps.gpg_check.outputs.configured == 'false' &&
          steps.check_signature.outputs.signed == 'false'
        run: |
          echo "::warning::No GPG key configured. Commits unsigned."
          echo "::warning::Add GPG_PRIVATE_KEY to repository secrets."
          echo "::warning::See GPG_SIGNING.md for instructions."
